# Процесс выпуска для GAC

Этот документ описывает процесс выпуска новых версий GAC в PyPI с использованием автоматизированных GitHub Actions.

## Обзор

GAC использует автоматизированный процесс выпуска. Когда вы отправляете версионный тег в GitHub, рабочий процесс GitHub Actions автоматически собирает и публикует пакет в PyPI. **Ручная загрузка не требуется.**

## Предпосылки

1. **Доступ к репозиторию**: Вам нужен доступ к отправке в основной репозиторий
2. **GitHub Actions**: Репозиторий должен иметь `PYPI_API_TOKEN`, настроенный в секретах (уже настроено)
3. **Локальные инструменты**:

   ```bash
   uv pip install -e ".[dev]"  # включает bump-my-version для управления версиями
   ```

## Контрольный список выпуска

### 1. Предварительные проверки

- [ ] Все тесты проходят: `make test`
- [ ] Код отформатирован: `make format`
- [ ] Проверка linting проходит: `make lint`
- [ ] Нет не закоммиченных изменений: `git status`
- [ ] На ветке `main`: `git checkout main`
- [ ] Получить последние изменения: `git pull origin main`

### 2. Увеличение версии

Обновите версию в `src/gac/__version__.py`:

```python
__version__ = "2.3.0"  # новая версия
```

#### Вариант 1: Ручной

Отредактируйте файл напрямую следуя [Семантическому версионированию](https://semver.org/):

- **Patch** (1.6.X): Исправления ошибок, небольшие улучшения
- **Minor** (1.X.0): Новые функции, обратно совместимые изменения (например, добавление нового поставщика)
- **Major** (X.0.0): Обратно несовместимые изменения

#### Вариант 2: Использование bump-my-version

```bash
# Для исправлений ошибок:
bump-my-version bump patch

# Для новых функций:
bump-my-version bump minor

# Для обратно несовместимых изменений:
bump-my-version bump major
```

### 3. Обновить Changelog

Обновите `CHANGELOG.md` с:

- Номером версии и датой
- Новыми функциями
- Исправлениями ошибок
- Обратно несовместимыми изменениями (если есть)
- Участниками

**Пример:**

```markdown
## [2.3.0] - 2024-01-15

### Добавлено

- Поддержка нового поставщика Z.AI
- Интерактивный выбор языка с `gac language`

### Исправлено

- Ложные срабатывания сканера секретов для примеров файлов

### Изменено

- Улучшены сообщения об ошибках для отсутствующих API-ключей
```

### 4. Закоммитить изменения версии

```bash
# Закоммитить увеличение версии и changelog
git add src/gac/__version__.py CHANGELOG.md
git commit -m "chore(version): bump with 2.2.0 на 2.3.0"
git push origin main
```

### 5. Создать и отправить тег выпуска

**Этот шаг запускает автоматический выпуск!**

```bash
# Создать версионный тег
git tag v2.3.0  # Используйте вашу фактическую версию (должна соответствовать __version__.py)

# Отправить тег в GitHub
git push origin v2.3.0
```

**Что происходит дальше:**

1. Рабочий процесс GitHub Actions (`.github/workflows/publish.yml`) запускается
2. Рабочий процесс проверяет, что версия тега соответствует `src/gac/__version__.py`
3. Пакет автоматически собирается с использованием `uv build`
4. Пакет автоматически публикуется в PyPI с использованием `twine`
5. Вы получите уведомление, если это не удастся

Следите за [вкладкой Actions](https://github.com/cellwebb/gac/actions), чтобы отслеживать прогресс выпуска.

### 6. Проверка после выпуска

1. **Проверить GitHub Actions**:

   - Перейдите на [вкладку Actions](https://github.com/cellwebb/gac/actions)
   - Проверьте, что рабочий процесс "Publish to PyPI" успешно завершился
   - Проверьте наличие ошибок в логах

2. **Проверить на PyPI**:

   - Проверьте [страницу проекта PyPI](https://pypi.org/project/gac/)
   - Убедитесь, что новая версия указана
   - Проверьте, что описание пакета и метаданные выглядят правильно

3. **Проверить установку**:

   ```bash
   # Установить новую версию
   uv tool install --reinstall gac

   # Проверить версию
   gac --version  # Должна показать новую версию
   ```

4. **Создать GitHub выпуск** (необязательно, но рекомендуется):

   - Перейдите на [Релизы](https://github.com/cellwebb/gac/releases)
   - Нажмите "Draft a new release"
   - Выберите ваш тег
   - Скопируйте записи changelog в заметки о выпуске
   - Опубликуйте выпуск

## Детали автоматизированного рабочего процесса

### Как это работает

Рабочий процесс в `.github/workflows/publish.yml`:

1. **Запускается** на тегах, соответствующих `v[0-9]+.[0-9]+.[0-9]+` (например, `v2.3.0`)
2. **Извлекает** версию из имени тега
3. **Проверяет**, что версия тега соответствует `src/gac/__version__.py`
4. **Собирает** пакет с использованием `uv build`
5. **Публикует** в PyPI с использованием `twine` с секретом `PYPI_API_TOKEN`

### Преимущества

- ✅ Ручная загрузка не требуется
- ✅ Последовательная среда сборки
- ✅ Автоматическая проверка версии
- ✅ Чёткий след аудита в логах GitHub Actions
- ✅ Нельзя случайно опубликовать неправильную версию
- ✅ Можно слить несколько PR перед выпуском

## Нумерация версий

Следуйте [Семантическому версионированию](https://semver.org/):

- **MAJOR.MINOR.PATCH** (например, 2.3.0)
- **MAJOR**: Обратно несовместимые изменения (редко)
- **MINOR**: Новые функции, обратно совместимые (большинство выпусков)
- **PATCH**: Исправления ошибок, небольшие улучшения

**Примеры:**

- Добавление нового поставщика: MINOR увеличение (2.3.0 → 2.4.0)
- Исправление ошибки: PATCH увеличение (2.3.0 → 2.3.1)
- Изменение флагов CLI: MAJOR увеличение (2.3.0 → 3.0.0)

## Устранение неполадок

### Рабочий процесс GitHub Actions не удался

**Проверьте логи:**

1. Перейдите на [вкладку Actions](https://github.com/cellwebb/gac/actions)
2. Нажмите на неудачный запуск рабочего процесса
3. Проверьте, на каком шаге произошёл сбой

**Общие проблемы:**

- **Несоответствие версии**: Версия тега не соответствует `src/gac/__version__.py`
  - Исправление: Удалите тег, обновите версию, создайте тег снова
- **Сбой сборки**: Ошибки сборки пакета
  - Исправление: Протестируйте сборку локально с `uv build`, исправьте ошибки, отправьте изменения
- **Сбой загрузки PyPI**: Аутентификация или дублирование версии
  - Исправление: Проверьте, что токен PyPI действителен в секретах репозитория

### Удалить тег (если нужно)

Если вы отправили неправильный тег:

```bash
# Удалить локальный тег
git tag -d v2.3.0

# Удалить удалённый тег
git push --delete origin v2.3.0
```

Затем исправьте проблему и создайте новый тег.

### Версия уже существует на PyPI

PyPI не позволяет повторную загрузку той же версии. Если вам нужно исправить плохой выпуск:

1. **Отозвать выпуск** на PyPI (предотвращает новые установки)
2. Исправить проблему в вашем коде
3. Увеличить до новой patch версии (например, 2.3.0 → 2.3.1)
4. Выпустить новую версию

**Никогда не используйте повторно номер версии, который был опубликован в PyPI.**

### Тестирование перед выпуском

Чтобы протестировать сборку пакета без публикации:

```bash
# Очистить старые сборки
rm -rf dist/ build/ *.egg-info

# Собрать пакет
uv build

# Проверить дистрибутив
uvx twine check dist/*

# Протестировать установку локально
uv pip install dist/*.whl
```

## Экстренные процедуры

### Отзыв плохого выпуска

Если после выпуска обнаружена критическая ошибка:

1. **Отозвать на PyPI**:

   - Перейдите на [страницу проекта PyPI](https://pypi.org/project/gac/)
   - Выберите версию
   - Нажмите "Options" → "Yank release"
   - Добавьте причину (например, "Критическая ошибка в сканере секретов")

2. **Выпустить исправление**:
   - Исправить ошибку
   - Увеличить до новой patch версии
   - Следовать обычному процессу выпуска

Отзыв не удаляет выпуск, но предотвращает новые установки, позволяя существующим пользователям продолжать использовать.

### Отмена выпуска

Вы **не можете** удалить или заменить версию на PyPI. Варианты:

1. **Отозвать** плохую версию (рекомендуется)
2. **Выпустить исправление** как новую patch версию
3. **Сообщить** о проблеме пользователям через GitHub Issues/Discussions

## Заметки о безопасности

- ✅ `PYPI_API_TOKEN` хранится в секретах репозитория GitHub
- ✅ Только поддерживающие с доступом к отправке могут запускать выпуски
- ✅ Все выпуски логируются в GitHub Actions
- ✅ Никогда не коммитьте токены в git
- ✅ Периодически меняйте токены

## Быстрый справочник

```bash
# Полный процесс выпуска (предполагая, что версия уже увеличена)
git checkout main
git pull origin main
git tag v2.3.0
git push origin v2.3.0

# Отслеживать выпуск
open https://github.com/cellwebb/gac/actions

# Проверить после выпуска
uv tool install --reinstall gac
gac --version
```

## Нужна помощь?

- Проверьте [логи GitHub Actions](https://github.com/cellwebb/gac/actions)
- Ознакомьтесь с [CONTRIBUTING.md](CONTRIBUTING.md) для руководств по разработке
- Откройте заявку, если столкнулись с проблемами
