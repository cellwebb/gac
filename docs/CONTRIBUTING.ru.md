# Участие в разработке gac

**[Русский](CONTRIBUTING.ru.md)** | [English](CONTRIBUTING.md) | [简体中文](CONTRIBUTING.zh-CN.md) | [繁體中文](CONTRIBUTING.zh-TW.md) | [日本語](CONTRIBUTING.ja.md) | [Français](CONTRIBUTING.fr.md) | [Español](CONTRIBUTING.es.md) | [Português](CONTRIBUTING.pt.md) | [हिन्दी](CONTRIBUTING.hi.md)

Спасибо за ваш интерес к участию в этом проекте! Ваша помощь ценится. Пожалуйста, следуйте этим рекомендациям, чтобы сделать процесс гладким для всех.

## Содержание

- [Участие в разработке gac](#участие-в-разработке-gac)
  - [Содержание](#содержание)
  - [Настройка среды разработки](#настройка-среды-разработки)
    - [Быстрая настройка](#быстрая-настройка)
    - [Альтернативная настройка (если предпочитаете шаг за шагом)](#альтернативная-настройка-если-предпочитаете-шаг-за-шагом)
    - [Доступные команды](#доступные-команды)
  - [Увеличение версии](#увеличение-версии)
    - [Как увеличить версию](#как-увеличить-версию)
    - [Процесс выпуска](#процесс-выпуска)
    - [Использование bump-my-version (необязательно)](#использование-bump-my-version-необязательно)
  - [Добавление нового поставщика AI](#добавление-нового-поставщика-ai)
    - [Контрольный список для добавления нового поставщика](#контрольный-список-для-добавления-нового-поставщика)
    - [Пример реализации](#пример-реализации)
    - [Ключевые моменты](#ключевые-моменты)
  - [Стандарты кодирования](#стандарты-кодирования)
  - [Git хуки (Lefthook)](#git-хуки-lefthook)
    - [Настройка](#настройка)
    - [Пропуск Git хуков](#пропуск-git-хуков)
  - [Рекомендации по тестированию](#рекомендации-по-тестированию)
    - [Запуск тестов](#запуск-тестов)
      - [Интеграционные тесты поставщиков](#интеграционные-тесты-поставщиков)
  - [Кодекс поведения](#кодекс-поведения)
  - [Лицензия](#лицензия)
  - [Где получить помощь](#где-получить-помощь)

## Настройка среды разработки

Этот проект использует `uv` для управления зависимостями и предоставляет Makefile для общих задач разработки:

### Быстрая настройка

```bash
# Одна команда для настройки всего, включая хуки Lefthook
make dev
```

Эта команда выполнит:

- Установит зависимости разработки
- Установит git хуки
- Запустит хуки Lefthook по всем файлам для исправления существующих проблем

### Альтернативная настройка (если предпочитаете шаг за шагом)

```bash
# Создать виртуальное окружение и установить зависимости
make setup

# Установить зависимости разработки
make dev

# Установить хуки Lefthook
brew install lefthook  # или смотрите docs ниже для альтернатив
lefthook install
lefthook run pre-commit --all
```

### Доступные команды

- `make setup` - Создать виртуальное окружение и установить все зависимости
- `make dev` - **Полная настройка разработки** - включает хуки Lefthook
- `make test` - Запустить стандартные тесты (исключает интеграционные тесты)
- `make test-integration` - Запустить только интеграционные тесты (требует API-ключи)
- `make test-all` - Запустить все тесты
- `make test-cov` - Запустить тесты с отчётом о покрытии
- `make lint` - Проверить качество кода (ruff, prettier, markdownlint)
- `make format` - Автоматически исправить проблемы форматирования кода

## Увеличение версии

**Важно**: PR должны включать увеличение версии в `src/gac/__version__.py`, когда они содержат изменения, которые должны быть выпущены.

### Как увеличить версию

1. Отредактируйте `src/gac/__version__.py` и увеличьте номер версии
2. Следуйте [Семантическому версионированию](https://semver.org/):
   - **Patch** (1.6.X): Исправления ошибок, небольшие улучшения
   - **Minor** (1.X.0): Новые функции, обратно совместимые изменения (например, добавление нового поставщика)
   - **Major** (X.0.0): Обратно несовместимые изменения

### Процесс выпуска

Выпуски запускаются отправкой версионных тегов:

1. Слейте PR(ы) с увеличением версии в main
2. Создайте тег: `git tag v1.6.1`
3. Отправьте тег: `git push origin v1.6.1`
4. GitHub Actions автоматически публикует в PyPI

Пример:

```python
# src/gac/__version__.py
__version__ = "1.6.1"  # Увеличено с 1.6.0
```

### Использование bump-my-version (необязательно)

Если у вас установлен `bump-my-version`, вы можете использовать его локально:

```bash
# Для исправлений ошибок:
bump-my-version bump patch

# Для новых функций:
bump-my-version bump minor

# Для обратно несовместимых изменений:
bump-my-version bump major
```

## Добавление нового поставщика AI

При добавлении нового поставщика AI вам нужно обновить несколько файлов в кодовой базе. Следуйте этому всеобъемлющему контрольному списку:

### Контрольный список для добавления нового поставщика

- [ ] **1. Создать реализацию поставщика** (`src/gac/providers/<provider_name>.py`)

  - Создайте новый файл с именем поставщика (например, `minimax.py`)
  - Реализуйте `call_<provider>_api(model: str, messages: list[dict], temperature: float, max_tokens: int) -> str`
  - Используйте формат совместимый с OpenAI, если поставщик его поддерживает
  - Обработайте API-ключ из переменной окружения `<PROVIDER>_API_KEY`
  - Включите правильную обработку ошибок с типами `AIError`:
    - `AIError.authentication_error()` для проблем с аутентификацией
    - `AIError.rate_limit_error()` для ограничения скорости (HTTP 429)
    - `AIError.timeout_error()` для таймаутов
    - `AIError.model_error()` для ошибок модели и пустого/null содержимого
  - Установите URL конечной точки API
  - Используйте 120-секундный таймаут для HTTP-запросов

- [ ] **2. Зарегистрировать поставщика в пакете** (`src/gac/providers/__init__.py`)

  - Добавьте импорт: `from .<provider> import call_<provider>_api`
  - Добавьте в список `__all__`: `"call_<provider>_api"`

- [ ] **3. Зарегистрировать поставщика в модуле AI** (`src/gac/ai.py`)

  - Добавьте импорт в секции `from gac.providers import (...)`
  - Добавьте в словарь `provider_funcs`: `"provider-name": call_<provider>_api`

- [ ] **4. Добавить в список поддерживаемых поставщиков** (`src/gac/ai_utils.py`)

  - Добавьте `"provider-name"` в список `supported_providers` в `generate_with_retries()`
  - Держите список отсортированным по алфавиту

- [ ] **5. Добавить в интерактивную настройку** (`src/gac/init_cli.py`)

  - Добавьте кортеж в список `providers`: `("Provider Name", "default-model-name")`
  - Держите список отсортированным по алфавиту
  - Добавьте специальную обработку при необходимости (как для Ollama/LM Studio для локальных поставщиков)

- [ ] **6. Обновить пример конфигурации** (`.gac.env.example`)

  - Добавьте пример конфигурации модели в формате: `# GAC_MODEL=provider:model-name`
  - Добавьте запись API-ключа: `# <PROVIDER>_API_KEY=your_key_here`
  - Держите записи отсортированными по алфавиту
  - Добавьте комментарии для необязательных ключей, если применимо

- [ ] **7. Обновить документацию** (`README.md` и `README.zh-CN.md`)

  - Добавьте имя поставщика в секцию "Поддерживаемые поставщики" в английском и китайском README
  - Держите список отсортированным по алфавиту в его маркерах

- [ ] **8. Создать всеобъемлющие тесты** (`tests/providers/test_<provider>.py`)

  - Создайте тестовый файл следуя соглашению об именовании
  - Включите эти тестовые классы:
    - `Test<Provider>Imports` - Тест импорта модуля и функции
    - `Test<Provider>APIKeyValidation` - Тест ошибки отсутствия API-ключа
    - `Test<Provider>ProviderMocked(BaseProviderTest)` - Наследуйте от `BaseProviderTest` для 9 стандартных тестов
    - `Test<Provider>EdgeCases` - Тест null содержимого и других крайних случаев
    - `Test<Provider>Integration` - Тесты реальных вызовов API (отмечены `@pytest.mark.integration`)
  - Реализуйте требуемые свойства в смоделированном тестовом классе:
    - `provider_name` - Имя поставщика (в нижнем регистре)
    - `provider_module` - Полный путь модуля
    - `api_function` - Ссылка на API функцию
    - `api_key_env_var` - Имя переменной окружения для API-ключа (или None для локальных поставщиков)
    - `model_name` - Имя модели по умолчанию для тестирования
    - `success_response` - Смоделированный успешный ответ API
    - `empty_content_response` - Смоделированный ответ пустого содержимого

- [ ] **9. Увеличить версию** (`src/gac/__version__.py`)
  - Увеличьте **minor** версию (например, 1.10.2 → 1.11.0)
  - Добавление поставщика - это новая функция и требует увеличения minor версии

### Пример реализации

Смотрите реализацию поставщика MiniMax как справочник:

- Поставщик: `src/gac/providers/minimax.py`
- Тесты: `tests/providers/test_minimax.py`

### Ключевые моменты

1. **Обработка ошибок**: Всегда используйте соответствующий тип `AIError` для разных сценариев ошибок
2. **Null/пустое содержимое**: Всегда проверяйте и `None`, и пустое строковое содержимое в ответах
3. **Тестирование**: Класс `BaseProviderTest` предоставляет 9 стандартных тестов, которые каждый поставщик должен наследовать
4. **Алфавитный порядок**: Держите списки поставщиков отсортированными по алфавиту для поддерживаемости
5. **Именование API-ключей**: Используйте формат `<PROVIDER>_API_KEY` (все в верхнем регистре, подчеркивания для пробелов)
6. **Формат имени поставщика**: Используйте нижний регистр с дефисами для многословных имен (например, "lm-studio")
7. **Увеличение версии**: Добавление поставщика требует **minor** увеличения версии (новая функция)

## Стандарты кодирования

- Цель: Python 3.10+ (3.10, 3.11, 3.12, 3.13, 3.14)
- Используйте подсказки типов для всех параметров функций и возвращаемых значений
- Держите код чистым, компактным и читаемым
- Избегайте ненужной сложности
- Используйте логирование вместо print-выражений
- Форматирование обрабатывается `ruff` (проверка, форматирование и сортировка импортов в одном инструменте; максимальная длина строки: 120)
- Пишите минимальные, эффективные тесты с `pytest`

## Git хуки (Lefthook)

Этот проект использует [Lefthook](https://github.com/evilmartians/lefthook) для поддержания проверок качества кода быстрыми и последовательными. Настроенные хуки зеркалируют нашу предыдущую настройку pre-commit:

- `ruff` - Проверка и форматирование Python (заменяет black, isort и flake8)
- `markdownlint-cli2` - Проверка Markdown
- `prettier` - Форматирование файлов (markdown, yaml, json)
- `check-upstream` - Пользовательский хук для проверки изменений upstream

### Настройка

**Рекомендуемый подход:**

```bash
make dev
```

**Ручная настройка (если предпочитаете шаг за шагом):**

1. Установите Lefthook (выберите опцию, соответствующую вашей настройке):

   ```sh
   brew install lefthook          # macOS (Homebrew)
   # или
   cargo install lefthook         # Rust toolchain
   # или
   asdf plugin add lefthook && asdf install lefthook latest
   ```

2. Установите git хуки:

   ```sh
   lefthook install
   ```

3. (Необязательно) Запустите по всем файлам:

   ```sh
   lefthook run pre-commit --all
   ```

Хуки теперь будут запускаться автоматически при каждом коммите. Если какие-либо проверки не пройдут, вам нужно будет исправить проблемы перед коммитом.

### Пропуск Git хуков

Если вам нужно временно пропустить проверки Lefthook, используйте флаг `--no-verify`:

```sh
git commit --no-verify -m "Ваше сообщение коммита"
```

Примечание: Это следует использовать только при абсолютной необходимости, так как это обходит важные проверки качества кода.

## Рекомендации по тестированию

Проект использует pytest для тестирования. При добавлении новых функций или исправлении ошибок, пожалуйста, включайте тесты, которые покрывают ваши изменения.

Обратите внимание, что каталог `scripts/` содержит тестовые скрипты для функциональности, которую трудно протестировать с pytest. Не стесняйтесь добавлять скрипты здесь для тестирования сложных сценариев или интеграционных тестов, которые было бы трудно реализовать с использованием стандартного фреймворка pytest.

### Запуск тестов

```sh
# Запустить стандартные тесты (исключает интеграционные тесты с реальными вызовами API)
make test

# Запустить только интеграционные тесты поставщиков (требует API-ключи)
make test-integration

# Запустить все тесты включая интеграционные тесты поставщиков
make test-all

# Запустить тесты с покрытием
make test-cov

# Запустить конкретный тестовый файл
uv run -- pytest tests/test_prompt.py

# Запустить конкретный тест
uv run -- pytest tests/test_prompt.py::TestExtractRepositoryContext::test_extract_repository_context_with_docstring
```

#### Интеграционные тесты поставщиков

Интеграционные тесты поставщиков делают реальные вызовы API для проверки, что реализации поставщиков работают корректно с фактическими API. Эти тесты отмечены `@pytest.mark.integration` и пропускаются по умолчанию чтобы:

- Избегать потребления API-кредитов во время регулярной разработки
- Предотвратить сбои тестов, когда API-ключи не настроены
- Держать выполнение тестов быстрым для быстрой итерации

Для запуска интеграционных тестов поставщиков:

1. **Настройте API-ключи** для поставщиков, которые вы хотите протестировать:

   ```sh
   export ANTHROPIC_API_KEY="your-key"
   export CEREBRAS_API_KEY="your-key"
   export GEMINI_API_KEY="your-key"
   export GROQ_API_KEY="your-key"
   export OPENAI_API_KEY="your-key"
   export OPENROUTER_API_KEY="your-key"
   export STREAMLAKE_API_KEY="your-key"
   export ZAI_API_KEY="your-key"
   # LM Studio и Ollama требуют работы локального экземпляра
   # API-ключи для LM Studio и Ollama необязательны, если ваше развертывание не требует аутентификации
   ```

2. **Запустите тесты поставщиков**:

   ```sh
   make test-integration
   ```

Тесты будут пропускать поставщиков, где API-ключи не настроены. Эти тесты помогают обнаруживать изменения API на ранней стадии и обеспечивать совместимость с API поставщиков.

## Кодекс поведения

Будьте уважительными и конструктивными. Домогательства или оскорбительное поведение не будут терпеться.

## Лицензия

Участвуя, вы соглашаетесь, что ваши вклады будут лицензированы под той же лицензией, что и проект.

---

## Где получить помощь

- Для устранения неполадок смотрите [TROUBLESHOOTING.md](TROUBLESHOOTING.md)
- Для использования и опций CLI смотрите [../USAGE.md](../USAGE.md)
- Для деталей лицензии смотрите [../LICENSE](../LICENSE)

Спасибо за помощь в улучшении gac!
