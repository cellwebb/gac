# Publishes your package to PyPI using Astral/uv for builds.
# Set PYPI_API_TOKEN in repo secrets.

permissions:
  contents: write # Allows writing to the repository

name: Build and Publish to PyPI

on:
  push:
    branches:
      - main

jobs:
  build-publish:
    runs-on: ubuntu-latest
    permissions:
      contents: write # Allows writing to the repository
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Need full history for version bumping

      - name: Setup Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install uv, build, and twine
        run: pip install uv build twine

      - name: Setup uv virtual environment
        run: uv venv

      - name: Sync and bump version
        run: |
          # Install bump-my-version and packaging for version comparison
          pip install bump-my-version packaging

          # Sync versions between __version__.py and .bumpversion.cfg
          python3 << 'EOF'
          import re
          from packaging import version

          # Read version from __version__.py
          try:
              with open('src/gac/__version__.py', 'r') as f:
                  content = f.read()
                  match = re.search(r'__version__\s*=\s*["\']([^"\']+)["\']', content)
                  version_py = match.group(1) if match else "0.0.0"
          except FileNotFoundError:
              version_py = "0.0.0"

          # Read version from .bumpversion.cfg
          try:
              with open('.bumpversion.cfg', 'r') as f:
                  content = f.read()
                  match = re.search(r'current_version\s*=\s*([^\n]+)', content)
                  version_cfg = match.group(1).strip() if match else "0.0.0"
          except FileNotFoundError:
              version_cfg = "0.0.0"

          print(f"Version in __version__.py: {version_py}")
          print(f"Version in .bumpversion.cfg: {version_cfg}")

          # Compare and use the higher version
          if version.parse(version_py) > version.parse(version_cfg):
              print(f"Using higher version from __version__.py: {version_py}")
              higher_version = version_py
              needs_sync = True
          elif version.parse(version_cfg) > version.parse(version_py):
              print(f"Using higher version from .bumpversion.cfg: {version_cfg}")
              higher_version = version_cfg
              needs_sync = True
          else:
              print(f"Versions are equal: {version_py}")
              higher_version = version_py
              needs_sync = False

          # Write the results for bash to read
          with open('/tmp/sync_info.txt', 'w') as f:
              f.write(f"{higher_version}\n{needs_sync}")
          EOF

          # Read the sync info
          SYNC_INFO=$(cat /tmp/sync_info.txt)
          CURRENT_VERSION=$(echo "$SYNC_INFO" | head -n1)
          NEEDS_SYNC=$(echo "$SYNC_INFO" | tail -n1)

          echo "Synchronized version: $CURRENT_VERSION"

          # If versions were out of sync, update both files
          if [ "$NEEDS_SYNC" = "True" ]; then
            echo "Syncing version files to $CURRENT_VERSION"
            
            # Update .bumpversion.cfg
            if [ ! -f .bumpversion.cfg ]; then
              echo '[bumpversion]' > .bumpversion.cfg
              echo "current_version = $CURRENT_VERSION" >> .bumpversion.cfg
              echo 'commit = False' >> .bumpversion.cfg
              echo 'tag = False' >> .bumpversion.cfg
              echo '' >> .bumpversion.cfg
              echo '[bumpversion:file:src/gac/__version__.py]' >> .bumpversion.cfg
            else
              sed -i "s/current_version = .*/current_version = $CURRENT_VERSION/" .bumpversion.cfg
            fi
            
            # Update __version__.py
            echo '"""Version information for gac package."""' > src/gac/__version__.py
            echo "" >> src/gac/__version__.py
            echo "__version__ = \"$CURRENT_VERSION\"" >> src/gac/__version__.py
          fi

          # Check if version was modified in this push by comparing actual version content
          # This works for both squash merges and regular merges
          python3 << 'EOF'
          import re
          import subprocess
          import sys
          from packaging import version

          def get_version_from_commit(commit_sha, file_path):
              """Get version from a specific commit."""
              try:
                  result = subprocess.run(
                      ['git', 'show', f'{commit_sha}:{file_path}'],
                      capture_output=True, text=True, check=True
                  )
                  content = result.stdout
                  
                  if 'gac/__version__.py' in file_path:
                      match = re.search(r'__version__\s*=\s*["\']([^"\']+)["\']', content)
                  else:  # .bumpversion.cfg
                      match = re.search(r'current_version\s*=\s*([^\n]+)', content)
                  
                  return match.group(1).strip() if match else "0.0.0"
              except (subprocess.CalledProcessError, AttributeError):
                  return "0.0.0"

          def get_current_version():
              """Get current version from __version__.py"""
              try:
                  with open('src/gac/__version__.py', 'r') as f:
                      content = f.read()
                      match = re.search(r'__version__\s*=\s*["\']([^"\']+)["\']', content)
                      return match.group(1) if match else "0.0.0"
              except FileNotFoundError:
                  return "0.0.0"

          # Get commit SHAs
          before_sha = "${{ github.event.before }}"
          after_sha = "${{ github.event.after }}"

          # For new branch/repo, use HEAD~1
          if before_sha == "0000000000000000000000000000000000000000":
              try:
                  result = subprocess.run(['git', 'rev-parse', 'HEAD~1'], 
                                        capture_output=True, text=True, check=True)
                  before_sha = result.stdout.strip()
              except subprocess.CalledProcessError:
                  # If no previous commit, assume no version change
                  print("No previous commit found, proceeding with auto-bump")
                  sys.exit(1)

          # Get versions from before and after commits
          version_before = get_version_from_commit(before_sha, 'src/gac/__version__.py')
          version_current = get_current_version()

          print(f"Version before push: {version_before}")
          print(f"Version after push: {version_current}")

          # Compare versions
          try:
              if version.parse(version_current) > version.parse(version_before):
                  print("Version was bumped in this push, skipping auto-bump")
                  sys.exit(0)  # Skip auto-bump
              else:
                  print("No version bump detected, proceeding with auto-bump")
                  sys.exit(1)  # Proceed with auto-bump
          except Exception as e:
              print(f"Error comparing versions: {e}")
              print("Proceeding with auto-bump to be safe")
              sys.exit(1)
          EOF

          VERSION_BUMP_EXIT_CODE=$?
          if [ $VERSION_BUMP_EXIT_CODE -eq 0 ]; then
            echo "Skipping auto-bump - version was already updated"
          else
            echo "Proceeding with auto-bump"
            bump-my-version bump patch --allow-dirty
          fi

      - name: Build package
        run: |
          uv build

      - name: Publish to PyPI
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.PYPI_API_TOKEN }}
        run: uv run twine upload dist/*

      - name: Push version bump to GitHub
        if: ${{ success() }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add .
          git commit -m "chore: bump version [ci skip]" || echo "No changes to commit"
          git push
